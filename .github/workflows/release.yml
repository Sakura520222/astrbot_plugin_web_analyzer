name: Auto Release

on:
  push:
    branches: [ master ]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version from metadata
        id: get_current_version
        run: |
          # 使用 awk 提取版本号，支持 version: 后的任意空格
          VERSION=$(grep -E '^\s*version:' metadata.yaml | awk '{print $2}')
          echo "当前版本: $VERSION"
          echo "VERSION=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.get_current_version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "标签 ${{ steps.get_current_version.outputs.VERSION }} 已存在"
            echo "EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "标签 ${{ steps.get_current_version.outputs.VERSION }} 不存在，将创建新发布"
            echo "EXISTS=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog for current version
        id: extract_changelog
        run: |
          # 提取更新日志，保留空行以保持可读性
          VERSION="${{ steps.get_current_version.outputs.VERSION }}"
          echo "正在提取版本 $VERSION 的更新日志..."
          
          # 列出 CHANGELOG.md 中所有版本，用于调试
          echo "CHANGELOG.md 中的版本列表："
          grep -n "## \[" CHANGELOG.md
          
          # 查找当前版本的行号
          VERSION_LINE=$(grep -n "\[${VERSION}\]" CHANGELOG.md | cut -d':' -f1)
          
          if [ -z "$VERSION_LINE" ]; then
             echo "警告：在 CHANGELOG.md 中未找到版本 $VERSION"
             CHANGELOG_CONTENT="未找到版本 $VERSION 的更新日志"
          else
             echo "找到版本 $VERSION 在第 $VERSION_LINE 行"
             # 从当前版本下一行开始，直到下一个版本标题或文件结尾
             # 使用 sed 提取内容，保留空行
             CHANGELOG_CONTENT=$(tail -n +$((VERSION_LINE + 1)) CHANGELOG.md | sed '/^## \[/Q')
             # 如果内容为空，则使用默认消息
             if [ -z "$CHANGELOG_CONTENT" ]; then
                 CHANGELOG_CONTENT="此版本没有详细的更新日志内容。"
             fi
          fi
          
          echo "提取的更新日志内容长度: ${#CHANGELOG_CONTENT}"
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Package plugin files
        id: package
        run: |
          # 创建插件打包文件
          PLUGIN_NAME="astrbot_plugin_web_analyzer"
          ZIP_FILE="${PLUGIN_NAME}.zip"
          
          # 列出要包含的文件
          echo "打包插件文件到 $ZIP_FILE ..."
          zip -r "$ZIP_FILE" \
            main.py \
            metadata.yaml \
            requirements.txt \
            analyzer.py \
            cache.py \
            utils.py \
            _conf_schema.json \
            logo.png \
            README.md \
            LICENSE \
            CHANGELOG.md \
            wiki/ \
            .github/workflows/release.yml
          
          echo "打包完成，文件大小: $(du -h $ZIP_FILE | cut -f1)"
          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_OUTPUT

      - name: Create release
        if: steps.check_tag.outputs.EXISTS == 'false'
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_current_version.outputs.VERSION }}
          name: Release ${{ steps.get_current_version.outputs.VERSION }}
          body: |
            ${{ steps.extract_changelog.outputs.CHANGELOG }}
          files: ${{ steps.package.outputs.ZIP_FILE }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}