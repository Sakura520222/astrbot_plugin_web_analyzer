name: Auto Release

on:
  push:
    branches: [ master ]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version from metadata
        id: get_current_version
        run: |
          # 使用 awk 提取版本号，支持 version: 后的任意空格
          # 使用 tr 去除换行符和回车符
          VERSION=$(grep -E '^\s*version:' metadata.yaml | awk '{print $2}' | tr -d '\r\n')
          echo "当前版本: '$VERSION'"
          echo "版本长度: ${#VERSION}"
          echo "VERSION=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.get_current_version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "标签 ${{ steps.get_current_version.outputs.VERSION }} 已存在"
            echo "EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "标签 ${{ steps.get_current_version.outputs.VERSION }} 不存在，将创建新发布"
            echo "EXISTS=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog for current version
        id: extract_changelog
        run: |
          # 提取更新日志，保留空行以保持可读性
          VERSION="${{ steps.get_current_version.outputs.VERSION }}"
          # 修剪可能的换行符和回车符
          VERSION=$(echo "$VERSION" | tr -d '\r\n')
          echo "正在提取版本 '$VERSION' 的更新日志..."
          
          # 查找当前版本的行号，支持多种标题格式（### 或 ##）
          VERSION_LINE=$(grep -nE "^#{2,3} \[${VERSION}\]" CHANGELOG.md 2>/dev/null | head -n 1 | cut -d':' -f1)
          
          if [ -z "$VERSION_LINE" ]; then
            # 如果标题格式匹配失败，尝试简单匹配
            VERSION_LINE=$(grep -n -F "[${VERSION}]" CHANGELOG.md 2>/dev/null | head -n 1 | cut -d':' -f1)
          fi
          
          if [ -z "$VERSION_LINE" ]; then
             echo "警告：在 CHANGELOG.md 中未找到版本 $VERSION"
             CHANGELOG_CONTENT="未找到版本 $VERSION 的更新日志"
          else
             echo "找到版本 $VERSION 在第 $VERSION_LINE 行"
             
             # 从当前版本下一行开始，直到下一个版本标题或文件结尾
             # 使用 awk 更可靠地提取内容
             awk -v start="$VERSION_LINE" '
               NR > start {
                 if (/^#{1,3} \[v/) exit;
                 print;
               }
             ' CHANGELOG.md > /tmp/changelog.txt
             
             # 读取内容并移除末尾空行
             CHANGELOG_CONTENT=$(cat /tmp/changelog.txt | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}')
             
             if [ -z "$CHANGELOG_CONTENT" ]; then
                 CHANGELOG_CONTENT="此版本没有详细的更新日志内容。"
             fi
          fi
          
          echo "提取的更新日志内容长度: ${#CHANGELOG_CONTENT}"
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Package plugin files
        id: package
        run: |
          # 创建插件打包文件
          PLUGIN_NAME="astrbot_plugin_web_analyzer"
          ZIP_FILE="${PLUGIN_NAME}.zip"
          
          # 列出要包含的文件
          echo "打包插件文件到 $ZIP_FILE ..."
          zip -r "$ZIP_FILE" \
            main.py \
            metadata.yaml \
            requirements.txt \
            _conf_schema.json \
            logo.png \
            README.md \
            LICENSE \
            CHANGELOG.md \
            core/ \
            wiki/
          
          echo "打包完成，文件大小: $(du -h $ZIP_FILE | cut -f1)"
          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_OUTPUT

      - name: Create or update release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_current_version.outputs.VERSION }}
          name: Release ${{ steps.get_current_version.outputs.VERSION }}
          body: |
            ${{ steps.extract_changelog.outputs.CHANGELOG }}
          files: ${{ steps.package.outputs.ZIP_FILE }}
          draft: false
          prerelease: false
          generate_release_notes: false
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}